name: Send code to Dynatrace Business Event

on:
  push:
    branches: [ "dev" ]
    # Only run when the target file changes (optional but recommended)
    paths:
      - "sox-workflow.irn08782.mjs"
  workflow_dispatch: {}

defaults:
  run:
    shell: bash

jobs:
  ingest:
    runs-on: general-use
    env:
      DT_ENV: irn08782
      REPO: finance/finance-sox-js-library
      FILE_PATH: sox-workflow.irn08782.mjs

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Verify file exists
        run: |
          echo "==> Listing repo root"
          ls -la
          echo "==> Checking target file"
          test -f "$FILE_PATH" && echo "Found $FILE_PATH" || (echo "Missing $FILE_PATH" && exit 1)

      - name: Escape file content for JSON (same as before)
        id: content
        run: |
          ESCAPED_CONTENT=$(sed 's/\\/\\\\/g; s/"/\\"/g; :a;N;$!ba;s/\n/\\n/g' "$FILE_PATH")
          echo "json=$ESCAPED_CONTENT" >> $GITHUB_OUTPUT

      - name: Build JSON payload
        run: |
          cat > event.json <<'JSON'
          {
            "event.provider": "github-enterprise",
            "event.type": "com.sox.workflow.updated",
            "repo": "${{ env.REPO }}",
            "file": "${{ env.FILE_PATH }}",
            "commit.sha": "${{ github.sha }}",
            "github.run_id": "${{ github.run_id }}",
            "content": "__CODE_CONTENT__"
          }
          JSON
          sed -i "s|__CODE_CONTENT__|${{ steps.content.outputs.json }}|" event.json
          wc -c event.json
          head -c 800 event.json || true

      - name: Send to Dynatrace (expect HTTP 202)
        env:
          DYNATRACE_BIZEVENTS_TOKEN: ${{ secrets.DYNATRACE_BIZEVENTS_TOKEN }}
        run: |
          HTTP_STATUS=$(curl -sS \
            -X POST "https://${{ env.DT_ENV }}.live.dynatrace.com/api/v2/bizevents/ingest" \
            -H "Authorization: Api-Token ${DYNATRACE_BIZEVENTS_TOKEN}" \
            -H "Content-Type: application/json" \
            -D headers.txt \
            --data @event.json \
            -o response.json \
            -w "%{http_code}")
          echo "HTTP status: $HTTP_STATUS"
          echo "Headers:"; cat headers.txt || true
          echo "Body:"; cat response.json || true
          [ "$HTTP_STATUS" = "202" ] || (echo "Dynatrace ingest failed" && exit 1)