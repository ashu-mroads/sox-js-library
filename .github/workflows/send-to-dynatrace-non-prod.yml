name: Send code to Dynatrace Business Event

on:
  push:
    branches: [ "dev" ]
    # Only run when the target file changes (optional but recommended)
    paths:
      - "sox-workflow.irn08782.min.mjs"
  workflow_dispatch: {}

jobs:
  ingest:
    name: Ingest GitHub file as Business Event (verbose logging)
    runs-on: ubuntu-latest

    env:
      DT_ENV: irn08782
      REPO: finance/finance-sox-js-library
      FILE_PATH: sox-workflow.irn08782.min.mjs
      RAW_URL: https://git.marriott.com/finance/finance-sox-js-library/raw/main/sox-workflow.irn08782.min.mjs

    steps:
      - name: Start
        run: |
          echo "==> Workflow run for $REPO on branch: ${GITHUB_REF_NAME}"
          echo "==> Target raw URL: $RAW_URL"
          echo "==> Will send to: https://${{ env.DT_ENV }}.live.dynatrace.com/api/v2/bizevents/ingest"

      - name: Checkout (to read commit metadata)
        uses: actions/checkout@v4

      - name: Gather commit metadata
        id: meta
        run: |
          set -e
          echo "==> Collecting commit metadata"
          echo "sha=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
          echo "short_sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          echo "author=$(git log -1 --pretty=format:'%an')" >> $GITHUB_OUTPUT
          echo "author_email=$(git log -1 --pretty=format:'%ae')" >> $GITHUB_OUTPUT
          echo "committer=$(git log -1 --pretty=format:'%cn')" >> $GITHUB_OUTPUT
          echo "commit_msg=$(git log -1 --pretty=format:'%s' | sed 's/\"/\\"/g')" >> $GITHUB_OUTPUT
          echo "commit_time=$(git log -1 --pretty=format:'%cI')" >> $GITHUB_OUTPUT
          echo "branch=${GITHUB_REF_NAME}" >> $GITHUB_OUTPUT
          echo "==> Commit: $(git rev-parse --short HEAD) by $(git log -1 --pretty=format:'%an')"

      - name: Fetch file (with logging)
        run: |
          set -e
          echo "==> Downloading raw file from: $RAW_URL"
          curl -fsSL "$RAW_URL" -o "$FILE_PATH"
          echo "==> Download complete."
          echo "==> File info:"
          ls -l "$FILE_PATH"
          echo "==> First 10 lines (safe preview):"
          head -n 10 "$FILE_PATH" || true
          echo "==> File byte size:"
          wc -c "$FILE_PATH"

      - name: Escape file content for JSON
        id: content
        run: |
          set -e
          echo "==> Escaping content for JSON"
          # Escape backslashes and quotes; convert newlines to \n
          ESCAPED_CONTENT=$(sed 's/\\/\\\\/g; s/"/\\"/g; :a;N;$!ba;s/\n/\\n/g' "$FILE_PATH")
          # Limit preview to avoid log spam
          PREVIEW=$(echo "$ESCAPED_CONTENT" | head -c 500)
          echo "==> Escaped content preview (first 500 chars):"
          echo "$PREVIEW"
          echo "json=$ESCAPED_CONTENT" >> $GITHUB_OUTPUT

      - name: Build JSON payload
        id: payload
        run: |
          set -e
          echo "==> Building JSON payload"
          cat > event.json <<'JSON'
          {
            "event.provider": "github-enterprise",
            "event.type": "com.sox.workflow.updated",
            "repo": "${{ env.REPO }}",
            "file": "${{ env.FILE_PATH }}",
            "branch": "${{ steps.meta.outputs.branch }}",
            "commit.sha": "${{ steps.meta.outputs.sha }}",
            "commit.short_sha": "${{ steps.meta.outputs.short_sha }}",
            "commit.author": "${{ steps.meta.outputs.author }}",
            "commit.author_email": "${{ steps.meta.outputs.author_email }}",
            "commit.committer": "${{ steps.meta.outputs.committer }}",
            "commit.message": "${{ steps.meta.outputs.commit_msg }}",
            "commit.time": "${{ steps.meta.outputs.commit_time }}",
            "github.run_id": "${{ github.run_id }}",
            "github.run_number": "${{ github.run_number }}",
            "github.workflow": "${{ github.workflow }}",
            "source_url": "${{ env.RAW_URL }}",
            "content": "__CODE_CONTENT__"
          }
          JSON

          sed -i "s|__CODE_CONTENT__|${{ steps.content.outputs.json }}|" event.json

          echo "==> Payload byte size:"
          wc -c event.json
          echo "==> Payload preview (first 800 chars):"
          head -c 800 event.json && echo -e "\n...\n"

      - name: Send Business Event to Dynatrace (verbose)
        env:
          DYNATRACE_BIZEVENTS_TOKEN: ${{ secrets.DYNATRACE_BIZEVENTS_TOKEN }}
        run: |
          set -euo pipefail
          echo "==> Posting to Dynatrace Business Events API"
          echo "==> Endpoint: https://${{ env.DT_ENV }}.live.dynatrace.com/api/v2/bizevents/ingest"

          # Make the request; capture status code separately
          HTTP_STATUS=$(curl -sS \
            -X POST "https://${{ env.DT_ENV }}.live.dynatrace.com/api/v2/bizevents/ingest" \
            -H "Authorization: Api-Token ${DYNATRACE_BIZEVENTS_TOKEN}" \
            -H "Content-Type: application/json" \
            -D headers.txt \
            --data @event.json \
            -o response.json \
            -w "%{http_code}")

          echo "==> HTTP status: $HTTP_STATUS"
          echo "==> Response headers:"
          cat headers.txt || true
          echo "==> Response body:"
          cat response.json || true

          # Expect 202 Accepted per Dynatrace docs
          if [ "$HTTP_STATUS" != "202" ]; then
            echo "ERROR: Dynatrace ingest did not return 202. Failing the job."
            exit 1
          else
            echo "==> Success: Dynatrace returned 202 Accepted."
          fi