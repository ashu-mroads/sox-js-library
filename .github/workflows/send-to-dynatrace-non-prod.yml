name: Send code to Dynatrace Business Event

on:
  push:
    branches: [ "dev" ]
    paths:
      - "sox-workflow.irn08782.min.mjs"
  workflow_dispatch: {}

jobs:
  ingest:
    # If your runner only has the "general-use" label (no "self-hosted"), change to:
    # runs-on: general-use
    runs-on: [self-hosted, general-use]

    defaults:
      run:
        shell: bash

    env:
      DT_ENV: irn08782
      REPO: finance/finance-sox-js-library
      FILE_PATH: sox-workflow.irn08782.min.mjs

    steps:
      - name: Start / Environment
        run: |
          echo "==> SHELL: $SHELL"
          echo "==> Dynatrace endpoint: https://${DT_ENV}.live.dynatrace.com/api/v2/bizevents/ingest"

      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Verify file exists and preview
        run: |
          set -Eeuo pipefail
          echo "==> Checking file: ${FILE_PATH}"
          if [ ! -f "${FILE_PATH}" ]; then
            echo "Missing ${FILE_PATH}"
            exit 1
          fi
          echo "==> Size (bytes):"
          wc -c "${FILE_PATH}" || true
          echo "==> First 10 lines:"
          head -n 10 "${FILE_PATH}" || true

      - name: Build JSON payload (Python one-liner; no heredoc/jq)
        run: |
          set -Eeuo pipefail
          python3 -c 'import os, json
          file_path = os.environ["FILE_PATH"]
          with open(file_path, "r", encoding="utf-8") as f:
          code = f.read()
          payload = {
          "event.provider": "github-enterprise",
          "event.type": "com.sox.workflow.updated",
          "repo": os.environ.get("REPO"),
          "file": file_path,
          "commit.sha": os.environ.get("GITHUB_SHA"),
          "github.run_id": os.environ.get("GITHUB_RUN_ID"),
          "content": code
          }
          with open("event.json", "w", encoding="utf-8") as out:
          json.dump(payload, out, ensure_ascii=False)
          '
          echo "==> Payload size (bytes):"
          wc -c event.json || true
          echo "==> Payload preview (first 500 chars):"
          head -c 500 event.json || true
          echo

      - name: Send to Dynatrace (expect HTTP 202)
        env:
          DYNATRACE_BIZEVENTS_TOKEN: ${{ secrets.DYNATRACE_BIZEVENTS_TOKEN }}
        run: |
          set -Eeuo pipefail
          echo "==> POST https://${DT_ENV}.live.dynatrace.com/api/v2/bizevents/ingest"
          HTTP_STATUS=$(curl -sS \
            -X POST "https://${DT_ENV}.live.dynatrace.com/api/v2/bizevents/ingest" \
            -H "Authorization: Api-Token ${DYNATRACE_BIZEVENTS_TOKEN}" \
            -H "Content-Type: application/json" \
            -D headers.txt \
            --data @event.json \
            -o response.json \
            -w "%{http_code}")

          echo "==> HTTP status: ${HTTP_STATUS}"
          echo "==> Response headers:"
          cat headers.txt || true
          echo "==> Response body:"
          cat response.json || true

          if [ "${HTTP_STATUS}" != "202" ]; then
            echo "ERROR: Dynatrace ingest did not return 202. Failing the job."
            exit 1
          fi

      - name: Success
        run: |
          echo "==> Business Event ingest completed (202 Accepted)."